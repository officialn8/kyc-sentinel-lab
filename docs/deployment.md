# Deployment (Vercel + Railway + Railway Postgres + Cloudflare R2 + Modal)

## 1) Cloudflare R2
- **Create a bucket** (name must match `R2_BUCKET`).
- **Create an API token / Access Key** with read/write to that bucket.
- **Set bucket CORS** (minimum for browser presigned PUT uploads from Vercel):

```json
[
  {
    "AllowedOrigins": ["https://YOUR_VERCEL_DOMAIN"],
    "AllowedMethods": ["GET", "PUT", "HEAD"],
    "AllowedHeaders": ["*"],
    "ExposeHeaders": ["ETag"],
    "MaxAgeSeconds": 3600
  }
]
```

Notes:
- Presigned URLs are generated by the backend; the browser uploads directly to R2.
- If you use a **custom R2 public domain** (recommended), set `NEXT_PUBLIC_R2_PUBLIC_HOSTNAME` in Vercel.

## 2) Modal (GPU processing)
From `backend/`:
- Deploy: `modal deploy modal_app.py`
- Create secret `r2-credentials` with:
  - `R2_ENDPOINT`, `R2_ACCESS_KEY`, `R2_SECRET_KEY`, `R2_BUCKET`

## 3) Railway (API + Worker + Postgres)

### 3.1 Postgres
- Provision Railway Postgres.
- Ensure `pgvector` can be enabled (migration runs `CREATE EXTENSION IF NOT EXISTS vector`).

### 3.2 API service (FastAPI)
Set env vars (minimum):
- `DATABASE_URL` (from Railway Postgres)
- `R2_ENDPOINT`, `R2_ACCESS_KEY`, `R2_SECRET_KEY`, `R2_BUCKET`
- `CORS_ORIGINS=https://YOUR_VERCEL_DOMAIN`
- `USE_MODAL=true`

Start command (recommended):
- `bash backend/scripts/railway_start.sh`

This runs `alembic upgrade head` then starts Uvicorn.

### 3.3 Worker service (durable processing)
Create a second Railway service pointing at the same repo.
Set the same env vars as the API.

Start command:
- `bash backend/scripts/railway_worker.sh`

## 4) Vercel (frontend)
Set env vars:
- `NEXT_PUBLIC_API_URL=https://YOUR_RAILWAY_API_DOMAIN` (no trailing slash)
- `BACKEND_API_URL=https://YOUR_RAILWAY_API_DOMAIN` (server-only)
- `BACKEND_API_KEY=...` (server-only, must match Railway backend `BACKEND_API_KEY` if you enable it)
- Optional: `NEXT_PUBLIC_R2_PUBLIC_HOSTNAME=media.yourdomain.com`

The frontend calls same-origin `/api/*`; `frontend/app/api/[...path]/route.ts` proxies to Railway and can inject `BACKEND_API_KEY` safely.


